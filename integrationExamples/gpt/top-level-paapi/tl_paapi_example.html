<html xmlns="http://www.w3.org/1999/html">
<head>
    <script async src="../../../../build/dev/prebid.js"></script>
    <script>
        // intercept navigator.runAdAuction and print parameters to console
        (() => {
            var originalRunAdAuction = navigator.runAdAuction;
            navigator.runAdAuction = function (...args) {
                console.log('%c runAdAuction', 'background: cyan; border: 2px; border-radius: 3px', ...args);
                return originalRunAdAuction.apply(navigator, args);
            };
        })();
    </script>

    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

    <script>
        var FAILSAFE_TIMEOUT = 3300;
        var PREBID_TIMEOUT = 3000;
        var adUnits = [{
                code: 'div-1',
                mediaTypes: {
                    banner: {
                        sizes: [[300, 250]],
                    }
                },
                ortb2Imp: {
                    ext: {
                        ae: 1
                    }
                },
                bids: [
                    {
                        bidder: 'optable',
                        params: {
                            site: 'daa30ba1-5613-4a2c-b7f0-34e2c033202a'
                        },
                    },
                ],
            }
            ]
        ;

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];
        googletag.cmd.push(function () {
            googletag.pubads().disableInitialLoad();
        });

        pbjs.que.push(function () {
            pbjs.setConfig({
                debug: true,
                paapi: {
                    enabled: true,
                    gpt: {
                        autoconfig: false
                    },
                    topLevelSeller: {
                        auctionConfig: {
                            seller: window.location.origin,
                            decisionLogicURL: new URL('decisionLogic.js', window.location).toString(),
                        }
                    }
                },
            });

            pbjs.addAdUnits(adUnits);
            pbjs.requestBids({
                bidsBackHandler: sendAdserverRequest,
                timeout: PREBID_TIMEOUT
            });
        });

        function raa() {
            return pbjs.getPAAPIBids().then(bids => {
                let contextual = false;
                Object.entries(bids).forEach(([adUnitCode, bid]) => {
                    const container = document.getElementById(adUnitCode);
                    const paapiDiv = container.querySelector('.paapi');
                    const gamDiv = container.querySelector('.gam');
                    if (bid) {
                        // if we have a paapi winner, hide the GAM slot
                        // and insert a paapi iframe
                        const iframe = document.createElement('iframe');
                        Object.assign(iframe, {
                            src: bid.urn,
                            frameBorder: 0,
                            scrolling: 'no',
                            width: bid.width,
                            height: bid.height,
                        });
                        paapiDiv.innerHTML = '';
                        paapiDiv.appendChild(iframe);
                        paapiDiv.style.display = 'block'
                        gamDiv.style.display = 'none';
                    } else {
                        // otherwise, hide the paapi iframe and show the ad slot
                        contextual = true;
                        paapiDiv.style.display = 'none';
                        gamDiv.style.display = 'block';
                    }
                });
                return contextual;
            });
        }

        function sendAdserverRequest() {
            if (pbjs.adserverRequestSent) return;
            pbjs.adserverRequestSent = true;
            raa().then((contextual) => {
                if (contextual) {
                    googletag.cmd.push(function () {
                        pbjs.que.push(function () {
                            pbjs.setTargetingForGPTAsync();
                            googletag.pubads().refresh();
                        });
                    });
                }
            });
        }

        setTimeout(function () {
            sendAdserverRequest();
        }, FAILSAFE_TIMEOUT);

        googletag.cmd.push(function () {
            googletag.defineSlot('/19968336/header-bid-tag-0', [[300, 250], [300, 600]], 'div-1-gam').addService(googletag.pubads());

            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script>
</head>

<body>
<h2>Standalone PAAPI Prebid.js Example</h2>
<p>Start local server with:</p>
<code>gulp serve-fast --https</code>
<p>Chrome flags:</p>
<code>--enable-features=CookieDeprecationFacilitatedTesting:label/treatment_1.2/force_eligible/true
    --privacy-sandbox-enrollment-overrides=https://localhost:9999</code>
<p>Join interest group at <a href="https://www.optable.co/">https://www.optable.co/</a>
</p>
<h5>Div-1</h5>

<div id="div-1" style='min-width: 300px; min-height: 250px;'>
    <div class="paapi"></div>
    <div id='div-1-gam' class="gam">
        <script type='text/javascript'>
            googletag.cmd.push(function () {
                googletag.display('div-1-gam');
            });
        </script>
    </div>
</div>

</body>
</html>
